services:
  db:
    ports:
      - "5432:5432"

  api:
    build:
      target: builder
    environment:
      - APP_ENV=dev
    volumes:
      - ./src:/app/src
      # Also mount alembic files for development
      - ./alembic:/app/alembic
      # Mount tests so they can be run inside the container if needed
      - ./tests:/app/tests
    # The command enables hot-reloading with watchmedo
    command: >
      sh -c "
        . /app/.venv/bin/activate &&
        watchmedo auto-restart --directory ./src --pattern '*.py' --recursive
        uvicorn src.main:app --host "${API_LISTEN_IP:-0.0.0.0}" --port "${API_PORT:-8000}"
      "
